<!DOCTYPE html>
<html>      
<head>
    <meta charset="utf-8">
    <title>Pie Chart with Dropdown</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div id="chart"></div>
    <div id="dropdown">
        <select id="suburbSelect"></select>
    </div>

    <script>
        const url = "http://127.0.0.1:5000/api/all-data-json";
        const chartDiv = document.getElementById("chart");
        const dropdown = document.getElementById("suburbSelect");

        // Load data from JSON file
        d3.json(url).then(function (data) {
            const suburbs = [...new Set(data.map(d => d.Suburb))];
            const types = [...new Set(data.map(d => d.Type))];

            // Create initial pie chart
            const chartData = createDataForSuburb(data, suburbs[0]);
            createChart(chartData);

            // Populate dropdown menu
            populateDropdown(suburbs);

            // Add change event listener to dropdown
            dropdown.addEventListener("change", function () {
                const selectedSuburb = this.value;
                const newData = createDataForSuburb(data, selectedSuburb);
                updateChart(newData);
            });

            function createDataForSuburb(data, suburb) {
                const filteredData = data.filter(d => d.Suburb === suburb);
                const typeCount = {};

                types.forEach(function (type) {
                    const count = filteredData.filter(d => d.Type === type).length;
                    typeCount[type] = count;
                });

                return {
                    values: Object.values(typeCount),
                    labels: Object.keys(typeCount),
                    type: "pie"
                };
            }

            function createChart(data) {
                const layout = {
                    title: "Property Types by Suburb",
                    height: 500,
                    width: 700
                };

                Plotly.newPlot(chartDiv, [data], layout);
            }

            function updateChart(data) {
                const chartData = {
                    values: data.values,
                    labels: data.labels,
                    type: "pie"
                };

                Plotly.react(chartDiv, [chartData]);
            }

            function populateDropdown(suburbs) {
                suburbs.forEach(function (suburb) {
                    const option = document.createElement("option");
                    option.text = suburb;
                    dropdown.add(option);
                });
            }
        });
    </script>
</body>
</html>